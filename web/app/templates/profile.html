{% extends "base.html" %}

{% block title %}My Profile{% endblock %}

{% block page_content %}

<h1> Your Profile </h1>
<table class="table">
    <tr><td>AGA ID</td>
        {% if user.aga_id is none %}
        <td><a href="{{url_for('verify.verify_form')}}"> Link your AGA account </a></td></tr>
        {% else %}
        <td>{{ user.aga_id }}</td></tr>
        {% endif%}
    <tr><td>Contact Email</td><td>{{ user.email }}</td></tr>
</table>

{% if user.is_server_admin() and user.servers %}
<h1>Your Game Server(s)</h1>
<table class="table">
    <tr><th>Name</th><th>URL</th><th>Token</th><th>Reset</th></tr>
    {% for s in user.servers %}
    <tr>
        <td>{{ s.name }}</td>
        <td>{{ s.url }}</td>
        <td>{{ s.token }}</td>
        <td><input type="button" value="Reset this token" class="reset-token" for="{{ s.id }}"></td>
    </tr>
    {% endfor %}
</table>
{% endif %}

{% if players %}
<div class="panel panel-default">
    <div class="panel-heading"> Your linked players </div>
    <table class="table">
        <tr> <th> Server </th> <th> Name </th> <th> Token </th> </tr>
        {% for p in players %}
        <tr>
            <td>{{p.server.name}}</td>
            <td>
                <a href="{{ url_for('ratings.player', player_id=p.id) }}">{{p.name}}</a>
            </td>
            <td>{{ p.token }}</td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
{{super()}}
<script type="text/javascript">
var csrftoken = "{{ csrf_token() }}";

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken)
        }
    }
})

function reset_server_token(server_id) {
    var TOKEN_RESET_ENDPOINT = "{{ url_for('ratings.reset_server_token', server_id='replacethis') }}";
    return $.ajax({
        method: "POST",
        url: TOKEN_RESET_ENDPOINT.replace("replacethis", server_id)
    });
}

$("input.reset-token").click(function () {
    if (window.confirm("Do you really want to reset your token?")) {
        var server_id = $(this).attr("for");
        reset_server_token(server_id)
            .then(function(response) {
                alert("Success!");
                location.reload();
            });
    }
})
</script>
{% endblock %}